---
title: "Peer-graded Assignment: Regression Models Course"
author: "Cristian Neuhaus"
date: "6/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r color_text, , include=FALSE}
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}
```
# **`r colorize("Executive Summary", "green")`**  

This study is part of Coursera - Peer-graded Assignment for Regression Models Course and are using *mtcars* data set. Where a magazine about the automobile industry is looking at a data set of a collection of cars, they are interested in exploring the relationship between a set of variables and miles per gallon (MPG) (outcome).  
The proposal of this report is to answer two questions:  

* “Is an automatic or manual transmission better for MPG”
* "Quantify the MPG difference between automatic and manual transmissions"  

Thought the initial analysis as a boxplot, t-test and linear regressions between automatic and manual transmission vehicles, it appears that manual transmission vehicles have a better performance than automatic transmission. But after fitting multiple linear regressions, the analysis showed that the manual transmission contributed less to MPG compared to the others variables available, likes as number of cylinders, weight and horsepower. Fill free to go to the next points for more details.  

# **`r colorize("Exploratory Data", "green")`**   

To provide an overview about the data, the Table below shows the first 3 rows of data.  

```{r include=TRUE, echo=FALSE}
data("mtcars")
head(mtcars,3)
```

According to the help file for this dataset, the data was extracted from the 1974 Motor Trend US magazine, and comprises fuel consumption and 10 aspects of automobile design and performance for 32 automobiles (1973–74 models).  

The data table contains **`r dim(mtcars)[1]`** observations in **`r dim(mtcars)[2]`** variables (numerical). Details on these variables are described below:

```{r echo=FALSE, warning=FALSE, include=FALSE}
if(!require(tidyverse))install.packages("tidyverse")
library(tidyverse)
man <- mtcars %>% filter(am == 1) %>% #1 = Manual
   select(mpg)
aut <- mtcars %>% filter(am == 0) %>% #0 = Automatic
   select(mpg)
```

The **Figure #1** shows a Boxplot that compares the Automatic x Manual transmission regarding to MPG. Also the **Figure #2** shows the Exponential means distribution for both. These pictures are the first evidence that trasmissions are a significant variable for MPG. It´s possible to see that Manual transmission cars have a better performance, **`r round(mean(man$mpg),2)` mpg** than Automatic transmission with **`r round(mean(aut$mpg),2)` mpg**.  
The next analysis will provide to us more details to confirm this point of view.  

# **`r colorize("Analysis", "green")`**   

### Analysis 1: T-test  

```{r echo=TRUE}
t.test(mtcars$mpg ~ mtcars$am)$p.value
```
This result, is the *p value*, that confirms that transmission sample mean is statistically significant with 95% of confidence for MPG performance. 

### Analysis 2: Regression Model  

```{r echo=TRUE}
data("mtcars")
mtcars <- mtcars %>% 
  mutate(am = ifelse(am == 0, "Automatic", "Manual"))
x <- summary(lm(mpg ~ am, data = mtcars))$coeff; x
```
The linear regression analysis with transmission variable, shows that manual transmission have about `r round(x[2,1],2)` MPG better performance than automatic vehicles. The intercept results is the same from the means, `r round(x[1,1],2)` for automatic and `r round(x[1,1],2)` + `r round(x[2,1],2)`= `r round(x[1,1]+x[2,1],2)` for manual transmissions.  
But according to the next linear regression analysis, it´s possible to see that transmission variable (am) contribute less the others variables to MPG.

```{r echo=TRUE, warning=FALSE, message=FALSE}
data("mtcars")
library(car)
fit <- lm(mpg ~ ., data = mtcars)
vif_result <- round(sqrt(vif(fit)),2)
vif_result
```
Using **Variance Inflation Factor** (vif), we can see that some of the variables are quite higher than *am* (transmission), like as *disp* variable (`r vif_result[2]`), *cyl* (`r vif_result[1]`), *wt* (`r vif_result[5]`) when it were orthogonal to all the other regressors.  
Also to verify that, pointed out a correlation table with the others variables where we can see that we have more significative variables to MPG outcome. Take a look below.  

```{r echo=TRUE, warning=FALSE, message=FALSE}
round(cor(mtcars),2)[,1]
```

```{r echo=TRUE, warning=FALSE, message=FALSE, include=FALSE}

fit1 <- lm(mpg ~ am, data = mtcars)
fit2 <- lm(mpg ~ am + disp, data = mtcars)
fit3 <- lm(mpg ~ am + disp + cyl, data = mtcars)
fit4 <- lm(mpg ~ am + disp + cyl + wt, data = mtcars)
fit5 <- lm(mpg ~ am + disp + cyl + wt + hp, data = mtcars)
fit6 <- lm(mpg ~ am + disp + cyl + wt + hp + carb, data = mtcars)
fit7 <- lm(mpg ~ am + disp + cyl + wt + hp + carb + qsec, data = mtcars)
fit8 <- lm(mpg ~ am + disp + cyl + wt + hp + carb + qsec + gear, data = mtcars)
fit9 <- lm(mpg ~ am + disp + cyl + wt + hp + carb + qsec + gear + vs, data = mtcars)
anova(fit1, fit2, fit3, fit4, fit5, fit6, fit7, fit8, fit)
```

To help to understant it better, it was provided some charts, **Figure #3** that shows also this corrrelations.

# **`r colorize("Conclusion", "green")`** 

In a single conclusion, comparing just the Mpg versus Transmission, we can say with 95% of confidence that Manual Transmission have a better performance than Automatic Transmission.  But we can not forget that we found a couple of variables that have a higher correlation with **mpg** than **ma** vars.  
Some examples are in **Figure #3**, that show us some important points that we need to consider.  
When we compare **mpg vs. disp**, it seems when engine displacement increase, than mpg decrease. And also the slope is higher for manual transmission. But we need to be care because almost all engines displacement over 200 are automatic. In the same way as **mpg vs. disp**, the **mpg vs. weight** have the same behavior, with a negative relation.  
In the other hand, we have **mpg vs. hp**, where  the manual transmission is better than the automatic. In both cases if horse power of the engine (hp) increases, the mileage (mpg) reduces.  The plot of **mpg vs. drat** shows that mpg increase more for manual transmission according we increase the rear axle ratio (draf).  

# **`r colorize("Appendix Figures", "green")`** 

```{r echo=FALSE, include=FALSE}
data("mtcars")
mtcars %>% 
    select(am) %>% 
    group_by(am) %>% 
    summarise(qty = n()) %>% 
    arrange(desc(qty)) %>%
    mutate(
          transmission = ifelse(am == 0, "Automatic","Manual")
    ) %>% 
    ggplot(aes(x="", y=qty, fill=transmission))+
      geom_bar(width = 1, stat = "identity") +
      coord_polar("y", start=0) +
      ggtitle("Transmission Type Distribution") +
      theme(plot.title = element_text(hjust = 0.5)) +
      scale_fill_manual(values=c("#367C2B", "#FFDE00"))
```

## Figure #1
```{r echo=TRUE}
boxplot(mtcars$mpg ~ mtcars$am, 
          xlab="Transmission Type (0 = Automatic, 1 = Manual)", 
          ylab="MPG",
          main="MPG by Transmission Type")
```

## Figure #2

```{r echo=TRUE}
mtcars %>% ggplot(aes(x = mpg))+
  geom_histogram(color = "black", fill = "white",aes(y=..density..)) +
  stat_function(fun = dnorm, args = list(mean = mean(man$mpg), sd = sd(man$mpg)),
  color="blue", size =1)+
  stat_density(geom = "line", color = "red", size =1) +
  geom_vline(aes(xintercept = mean(aut$mpg), col = "Sample Mean"),
  size = 1, col = "red") +
  geom_vline(aes(xintercept = mean(man$mpg), col = "Theoretical_mean"),
  size = 1, col = "blue") +
  labs(title="Exponential means distribution",
  subtitle = "Automatic mean (red) vs. Manual mean (blue)",
  x = "Means", y = "Density") +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r, question23, echo=TRUE, include=FALSE}
plot(step(lm(mpg ~ am, data = mtcars)), which=2)

```

## Figure #3  

```{r, echo=TRUE, include=FALSE, results=FALSE}

### Analysis MPG x disp
#par(mfrow = c(2, 2), mar = c(2, 3, 2, 3))
points_auto <-  mtcars %>% filter(am ==0)
points_manu <-  mtcars %>% filter(am ==1)

fit <- lm(mpg ~ disp, mtcars)
fit2 <- lm(mpg ~ disp, points_auto)
fit3 <- lm(mpg ~ disp, points_manu)
result <- predict(fit,data.frame(disp=3.000), interval="prediction")

plot(as.numeric(as.vector(mtcars$disp)), #predictor to check mpg with 3000 disp
    as.numeric(as.vector(mtcars$mpg)), #outcome
    main = "Mpg x disp by transmission type",
    pch = 21, col = "black", bg = "black", xlab = "Displacement (cu.in.)", ylab = "Mpg")
    legend("topright", pch = 21, col = c("red", "blue", "orange"), legend = c("auto", "manu", "avg point")) # add legend
    with(points_auto, points(disp, mpg, col = "red", pch = 20))
    with(points_manu, points(disp, mpg, col = "blue", pch = 20))
    #original regression line, mpg as outcome, disp as predictor
    abline(fit, lwd =0.5, col = "black")
    abline(fit2, lwd =0.5, col = "red")
    abline(fit3, lwd =0.5, col = "blue")
    abline(v = mean(points_manu$disp), col = "blue", lwd = 0.5, lty = 2)
    abline(h = mean(points_manu$mpg), col = "blue", lwd = 0.5, lty = 2)
    abline(v = mean(points_auto$disp), col = "red", lwd = 0.5, lty = 2)
    abline(h = mean(points_auto$mpg), col = "red", lwd = 0.5, lty = 2)
    abline(v = mean(mtcars$disp), col = "black", lwd = 0.5, lty = 2)
    abline(h = mean(mtcars$mpg), col = "black", lwd = 0.5, lty = 2)
    points(x = mean(points_manu$disp), y = mean(points_manu$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(points_auto$disp), y = mean(points_auto$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(mtcars$disp), y = mean(mtcars$mpg),cex = 2, pch = 21, col = "black", bg = "orange")

```

```{r, echo=FALSE, message=FALSE, results=FALSE}
### Analysis MPG x disp
par(mfrow = c(3, 2), mar = c(2, 3, 2, 3))

plot(step(lm(mpg ~ am, data = mtcars)), which=2)
plot(step(lm(mpg ~ am, data = mtcars)), which=3)

points_auto <-  mtcars %>% filter(am ==0)
points_manu <-  mtcars %>% filter(am ==1)

fit <- lm(mpg ~ disp, mtcars)
fit2 <- lm(mpg ~ disp, points_auto)
fit3 <- lm(mpg ~ disp, points_manu)
result <- predict(fit,data.frame(disp=3.000), interval="prediction")

plot(as.numeric(as.vector(mtcars$disp)), #predictor to check mpg with 3000 disp
    as.numeric(as.vector(mtcars$mpg)), #outcome
    main = "Mpg x disp by transmission type",
    pch = 21, col = "black", bg = "black", xlab = "Displacement (cu.in.)", ylab = "Mpg")
    legend("topright", pch = 21, col = c("red", "blue", "orange"), legend = c("auto", "manu", "avg point")) # add legend
    with(points_auto, points(disp, mpg, col = "red", pch = 20))
    with(points_manu, points(disp, mpg, col = "blue", pch = 20))
    #original regression line, mpg as outcome, disp as predictor
    abline(fit, lwd =0.5, col = "black")
    abline(fit2, lwd =0.5, col = "red")
    abline(fit3, lwd =0.5, col = "blue")
    abline(v = mean(points_manu$disp), col = "blue", lwd = 0.5, lty = 2)
    abline(h = mean(points_manu$mpg), col = "blue", lwd = 0.5, lty = 2)
    abline(v = mean(points_auto$disp), col = "red", lwd = 0.5, lty = 2)
    abline(h = mean(points_auto$mpg), col = "red", lwd = 0.5, lty = 2)
    abline(v = mean(mtcars$disp), col = "black", lwd = 0.5, lty = 2)
    abline(h = mean(mtcars$mpg), col = "black", lwd = 0.5, lty = 2)
    points(x = mean(points_manu$disp), y = mean(points_manu$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(points_auto$disp), y = mean(points_auto$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(mtcars$disp), y = mean(mtcars$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    
### Analysis MPG x hp
#par(mfrow = c(2, 2), mar = c(2, 3, 2, 3))
points_auto <-  mtcars %>% filter(am ==0)
points_manu <-  mtcars %>% filter(am ==1)

fit <- lm(mpg ~ hp, mtcars)
fit2 <- lm(mpg ~ hp, points_auto)
fit3 <- lm(mpg ~ hp, points_manu)
result <- predict(fit,data.frame(hp=3.000), interval="prediction")

plot(as.numeric(as.vector(mtcars$hp)), #predictor to check mpg with 3000 hp
    as.numeric(as.vector(mtcars$mpg)), #outcome
    main = "Mpg x hp by transmission type",
    pch = 21, col = "black", bg = "black", xlab = "Gross horsepower", ylab = "Mpg")
    legend("topright", pch = 21, col = c("red", "blue", "orange"), legend = c("auto", "manu", "avg point")) # add legend
    with(points_auto, points(hp, mpg, col = "red", pch = 20))
    with(points_manu, points(hp, mpg, col = "blue", pch = 20))
    #original regression line, mpg as outcome, hp as predictor
    abline(fit, lwd =0.5, col = "black")
    abline(fit2, lwd =0.5, col = "red")
    abline(fit3, lwd =0.5, col = "blue")
    abline(v = mean(points_manu$hp), col = "blue", lwd = 0.5, lty = 2)
    abline(h = mean(points_manu$mpg), col = "blue", lwd = 0.5, lty = 2)
    abline(v = mean(points_auto$hp), col = "red", lwd = 0.5, lty = 2)
    abline(h = mean(points_auto$mpg), col = "red", lwd = 0.5, lty = 2)
    abline(v = mean(mtcars$hp), col = "black", lwd = 0.5, lty = 2)
    abline(h = mean(mtcars$mpg), col = "black", lwd = 0.5, lty = 2)
    points(x = mean(points_manu$hp), y = mean(points_manu$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(points_auto$hp), y = mean(points_auto$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(mtcars$hp), y = mean(mtcars$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
### Analysis MPG x wt
#par(mfrow = c(2, 2), mar = c(2, 3, 2, 3))
points_auto <-  mtcars %>% filter(am ==0)
points_manu <-  mtcars %>% filter(am ==1)

fit <- lm(mpg ~ wt, mtcars)
fit2 <- lm(mpg ~ wt, points_auto)
fit3 <- lm(mpg ~ wt, points_manu)
result <- predict(fit,data.frame(wt=3.000), interval="prediction")

plot(as.numeric(as.vector(mtcars$wt)), #predictor to check mpg with 3000 wt
    as.numeric(as.vector(mtcars$mpg)), #outcome
    main = "Mpg x wt by transmission type",
    pch = 21, col = "black", bg = "black", xlab = "Weight (1000 lbs)", ylab = "Mpg")
    legend("topright", pch = 21, col = c("red", "blue", "orange"), legend = c("auto", "manu", "avg point")) # add legend
    with(points_auto, points(wt, mpg, col = "red", pch = 20))
    with(points_manu, points(wt, mpg, col = "blue", pch = 20))
    #original regression line, mpg as outcome, wt as predictor
    abline(fit, lwd =0.5, col = "black")
    abline(fit2, lwd =0.5, col = "red")
    abline(fit3, lwd =0.5, col = "blue")
    abline(v = mean(points_manu$wt), col = "blue", lwd = 0.5, lty = 2)
    abline(h = mean(points_manu$mpg), col = "blue", lwd = 0.5, lty = 2)
    abline(v = mean(points_auto$wt), col = "red", lwd = 0.5, lty = 2)
    abline(h = mean(points_auto$mpg), col = "red", lwd = 0.5, lty = 2)
    abline(v = mean(mtcars$wt), col = "black", lwd = 0.5, lty = 2)
    abline(h = mean(mtcars$mpg), col = "black", lwd = 0.5, lty = 2)
    points(x = mean(points_manu$wt), y = mean(points_manu$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(points_auto$wt), y = mean(points_auto$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(mtcars$wt), y = mean(mtcars$mpg),cex = 2, pch = 21, col = "black", bg = "orange")

### Analysis MPG x drat
#par(mfrow = c(2, 2), mar = c(2, 3, 2, 3))
points_auto <-  mtcars %>% filter(am ==0)
points_manu <-  mtcars %>% filter(am ==1)

fit <- lm(mpg ~ drat, mtcars)
fit2 <- lm(mpg ~ drat, points_auto)
fit3 <- lm(mpg ~ drat, points_manu)
result <- predict(fit,data.frame(drat=3.000), interval="prediction")

plot(as.numeric(as.vector(mtcars$drat)), #predictor to check mpg with 3000 drat
    as.numeric(as.vector(mtcars$mpg)), #outcome
    main = "Mpg x drat by transmission type",
    pch = 21, col = "black", bg = "black", xlab = "Rear axle ratio", ylab = "Mpg")
    legend("topright", pch = 21, col = c("red", "blue", "orange"), legend = c("auto", "manu", "avg point")) # add legend
    with(points_auto, points(drat, mpg, col = "red", pch = 20))
    with(points_manu, points(drat, mpg, col = "blue", pch = 20))
    #original regression line, mpg as outcome, drat as predictor
    abline(fit, lwd =0.5, col = "black")
    abline(fit2, lwd =0.5, col = "red")
    abline(fit3, lwd =0.5, col = "blue")
    abline(v = mean(points_manu$drat), col = "blue", lwd = 0.5, lty = 2)
    abline(h = mean(points_manu$mpg), col = "blue", lwd = 0.5, lty = 2)
    abline(v = mean(points_auto$drat), col = "red", lwd = 0.5, lty = 2)
    abline(h = mean(points_auto$mpg), col = "red", lwd = 0.5, lty = 2)
    abline(v = mean(mtcars$drat), col = "black", lwd = 0.5, lty = 2)
    abline(h = mean(mtcars$mpg), col = "black", lwd = 0.5, lty = 2)
    points(x = mean(points_manu$drat), y = mean(points_manu$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(points_auto$drat), y = mean(points_auto$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
    points(x = mean(mtcars$drat), y = mean(mtcars$mpg),cex = 2, pch = 21, col = "black", bg = "orange")
```

Plot 1 - Diagnostic QQ plot of standardized residuals.


